name: Deploy Agent Worker

on:
  push:
    paths:
      - 'agents/**'
      - '!agents/.logs/**'
    branches: [main]

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'agent') || contains(github.event.head_commit.message, 'worker')
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.WORKER_HOST }}
          username: ${{ secrets.WORKER_USER }}
          key: ${{ secrets.WORKER_SSH_KEY }}
          script: |
            echo "ğŸš€ Deploying EGOS Agent Worker..."
            cd ~/egos-lab
            git pull origin main
            bun install --frozen-lockfile
            
            # Restart the worker process
            if pm2 describe agent-worker > /dev/null 2>&1; then
              pm2 restart agent-worker
              echo "âœ… Worker restarted"
            else
              pm2 start agents/worker/index.ts --name agent-worker --interpreter bun
              pm2 save
              echo "âœ… Worker started for the first time"
            fi
            
            # Verify it's running
            sleep 2
            pm2 status agent-worker
