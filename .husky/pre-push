#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# â”€â”€ Step 1: Registry Lint (fast, ~1s) â”€â”€
echo "ğŸ” Pre-push: Validating agent registry..."
bun agents/cli.ts lint-registry 2>&1 | tail -3
if [ $? -ne 0 ]; then
  echo "âŒ Agent registry has errors. Push aborted."
  exit 1
fi

# â”€â”€ Step 2: Build egos-web (required, ~10s) â”€â”€
echo "ğŸ”¨ Pre-push: Building egos-web to prevent failed Vercel deploys..."
cd apps/egos-web && npx vite build --logLevel error 2>&1

if [ $? -ne 0 ]; then
  echo "âŒ Build FAILED. Push aborted. Fix build errors before pushing."
  echo "   Each failed deploy costs money. Fix locally first."
  exit 1
fi

cd ../..

# â”€â”€ Step 3: Contract + Integration Tests (opt-in, ~30s) â”€â”€
# Enable with: EGOS_TEST_GATE=1 git push origin main
if [ "$EGOS_TEST_GATE" = "1" ]; then
  echo "ğŸ§ª Pre-push: Running contract + integration tests..."
  set -a && source .env 2>/dev/null && set +a
  bun agent:test:exec 2>&1 | tail -20
  if [ $? -ne 0 ]; then
    echo "âŒ Test agents FAILED. Push aborted."
    exit 1
  fi
  echo "âœ… Tests passed."
else
  echo "â„¹ï¸  Skipping test agents (enable: EGOS_TEST_GATE=1 git push)"
fi

echo "âœ… All pre-push checks passed. Safe to push."
