# .windsurfrules — egos-lab Monorepo
# VERSION 2.0.0 — Updated 2026-02-17
# Sacred Code: 000.111.369.963.1618

---
project: "egos-lab"
type: "monorepo-lab + agentic-platform"
---

## SSOT (Single Source of Truth)

| Arquivo | Propósito | MAX linhas |
|---------|-----------|------------|
| `AGENTS.md` | Config do projeto, stack, commands | 200 |
| `TASKS.md` | Todas as tasks | 300 |
| `.windsurfrules` | Regras do agente (este arquivo) | 300 |
| `.guarani/PREFERENCES.md` | Padrões de código | 150 |
| `agents/registry/agents.json` | **Registry de agentes (SSOT)** | — |
| `docs/agentic/DIFFERENTIATORS.md` | Estratégia + posicionamento | 200 |

## PRIME DIRECTIVE

> **Rules govern agents. Agents enforce rules. Community evolves rules.**
> **NEVER write manual logic if a Tool (MCP) or Agent exists.**
> **NEVER mix egos-lab code with carteira-livre.**

## MANDAMENTOS

1. **ONE THING** — Cada agente faz UMA coisa. Cada app resolve UM problema.
2. **ZERO DEPS** — Agents use only Node/Bun stdlib. No framework dependencies.
3. **DRY-RUN FIRST** — Every agent MUST support `--dry` before `--exec`.
4. **REGISTRY** — No agent runs without a registry entry in `agents/registry/agents.json`.
5. **LOGS** — Every execution gets a correlation_id + JSONL structured log.
6. **COST** — AI calls use `packages/shared/ai-client.ts`. Cost tracked per call.
7. **SHARED** — Reusable code goes in `packages/shared/`. Zero duplication.
8. **STITCH** — UI designs go to Google Stitch before code.
9. **COMMIT** — Conventional commits every 30-60min (feat:/fix:/chore:/docs:).
10. **SCOPE** — Do ONLY what was asked. ASK before creating new features.

## AGENTIC PLATFORM

```bash
bun agent:list              # List all registered agents
bun agent:run <id> --dry    # Run agent in dry-run mode
bun agent:run <id> --exec   # Run agent in execute mode
bun agent:lint              # Validate registry
bun agent:ssot              # Quick: SSOT Auditor dry-run
```

### Architecture

```
agents/
├── cli.ts                  ← CLI entry point
├── runtime/runner.ts       ← Core: registry, logger, runner
├── registry/agents.json    ← All agent definitions (SSOT)
├── agents/*.ts             ← Agent implementations
├── evals/                  ← Eval suites (planned)
└── .logs/                  ← JSONL logs (gitignored)
```

### Agent Requirements

Every agent MUST have:
- Registry entry with id, area, risk_level, run_modes
- Correlation ID (auto from runner)
- JSONL logging (auto from runner)
- Dry-run mode (report only, no side effects)
- Idempotency (running twice = same result)

### Creating a New Agent

1. Add entry to `agents/registry/agents.json`
2. Create `agents/agents/<name>.ts` importing from `../runtime/runner`
3. Run `bun agent:lint` to validate
4. Test with `bun agent:run <id> --dry`
5. See full guide: `docs/agentic/how-to.md`

## CROSS-REPO RULES

| Repo | Purpose | Agents |
|------|---------|--------|
| `egos-lab` | Lab + Agentic Platform | 8 registered, 20 planned |
| `carteira-livre` | Production SaaS | Uses .guarani rules only |

## SECURITY

- **API Keys:** NEVER hardcode. Use `.env`. Server-side via Vercel proxy.
- **Pre-commit:** `scripts/security_scan.ts` runs automatically.
- **Recursion:** MAX_DEPTH ~50. IGNORE_DIRS includes External/.
- **PII:** Agents MUST mask CPF/email in all output.

## ENV VARS

```env
OPENROUTER_API_KEY=   # AI (Gemini via OpenRouter) — server-side only
GITHUB_TOKEN=         # GitHub API — server-side only
VITE_SUPABASE_URL=    # Supabase (client-safe)
VITE_SUPABASE_ANON_KEY= # Supabase anon (client-safe)
```
