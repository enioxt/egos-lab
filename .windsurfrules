# .windsurfrules â€” egos-lab Monorepo
# VERSION 2.1.0 â€” Updated 2026-02-17
# Sacred Code: 000.111.369.963.1618

---
project: "egos-lab"
type: "monorepo-lab + agentic-platform"
---

## SSOT (Single Source of Truth)

| Arquivo | PropÃ³sito | MAX linhas |
|---------|-----------|------------|
| `AGENTS.md` | Config do projeto, stack, commands | 200 |
| `TASKS.md` | Todas as tasks | 300 |
| `.windsurfrules` | Regras do agente (este arquivo) | 300 |
| `.guarani/PREFERENCES.md` | PadrÃµes de cÃ³digo | 150 |
| `agents/registry/agents.json` | **Registry de agentes (SSOT)** | â€” |
| `docs/agentic/DIFFERENTIATORS.md` | EstratÃ©gia + posicionamento | 200 |

## PRIME DIRECTIVE

> **Rules govern agents. Agents enforce rules. Community evolves rules.**
> **NEVER write manual logic if a Tool (MCP) or Agent exists.**
> **NEVER mix egos-lab code with carteira-livre.**

## MANDAMENTOS

1. **ONE THING** â€” Cada agente faz UMA coisa. Cada app resolve UM problema.
2. **ZERO DEPS** â€” Agents use only Node/Bun stdlib. No framework dependencies.
3. **DRY-RUN FIRST** â€” Every agent MUST support `--dry` before `--exec`.
4. **REGISTRY** â€” No agent runs without a registry entry in `agents/registry/agents.json`.
5. **LOGS** â€” Every execution gets a correlation_id + JSONL structured log.
6. **COST** â€” AI calls use `packages/shared/ai-client.ts`. Cost tracked per call.
7. **SHARED** â€” Reusable code goes in `packages/shared/`. Zero duplication.
8. **STITCH** â€” UI designs go to Google Stitch before code.
9. **COMMIT** â€” Conventional commits every 30-60min (feat:/fix:/chore:/docs:).
10. **SCOPE** â€” Do ONLY what was asked. ASK before creating new features.

## AGENTIC PLATFORM

```bash
bun agent:list              # List all registered agents
bun agent:run <id> --dry    # Run agent in dry-run mode
bun agent:run <id> --exec   # Run agent in execute mode
bun agent:lint              # Validate registry
bun agent:ssot              # Quick: SSOT Auditor dry-run
```

### Architecture

```
agents/
â”œâ”€â”€ cli.ts                  â† CLI entry point
â”œâ”€â”€ runtime/runner.ts       â† Core: registry, logger, runner
â”œâ”€â”€ registry/agents.json    â† All agent definitions (SSOT)
â”œâ”€â”€ agents/*.ts             â† Agent implementations
â”œâ”€â”€ evals/                  â† Eval suites (planned)
â””â”€â”€ .logs/                  â† JSONL logs (gitignored)
```

### Agent Requirements

Every agent MUST have:
- Registry entry with id, area, risk_level, run_modes
- Correlation ID (auto from runner)
- JSONL logging (auto from runner)
- Dry-run mode (report only, no side effects)
- Idempotency (running twice = same result)

### Creating a New Agent

1. Add entry to `agents/registry/agents.json`
2. Create `agents/agents/<name>.ts` importing from `../runtime/runner`
3. Run `bun agent:lint` to validate
4. Test with `bun agent:run <id> --dry`
5. See full guide: `docs/agentic/how-to.md`

## CROSS-REPO RULES

| Repo | Purpose | Agents |
|------|---------|--------|
| `egos-lab` | Lab + Agentic Platform | 10 registered + orchestrator, 20 planned |
| `carteira-livre` | Production SaaS | Uses .guarani rules only |

## DEPLOY DISCIPLINE (CRITICAL â€” Added 2026-02-17)

> **23 deploys in one day = wasted money.** Each `git push` triggers a Vercel deploy.

| Rule | Enforcement |
|------|-------------|
| **Commit often, push ONCE** | Batch all changes, push 1x per feature |
| **Build before push** | `.husky/pre-push` runs `vite build` automatically |
| **Max 3 pushes/session** | `ssot_governance.ts` warns if >10 commits/day |
| **Never push docs-only** | Docs don't need deploys. Use `--no-verify` only for docs |

```bash
# Safe push (build verified automatically):
git push origin main

# Docs-only push (skip build â€” saves time):
git push origin main --no-verify
```

## SECURITY

- **API Keys:** NEVER hardcode. Use `.env`. Server-side via Vercel proxy.
- **Pre-commit:** `scripts/hooks/entropy-check.js` runs automatically to calculate math entropy (H > 4.5) and blocks Base64/Obfuscated secrets from entering tracking.
- **Pre-push:** `.husky/pre-push` runs Vite build â€” blocks failed deploys.
- **Recursion:** MAX_DEPTH ~50. IGNORE_DIRS includes External/.
- **PII:** Agents MUST mask CPF/email in all output.
- **Volumetric DoS (APEX-SECURE):** Any API route handling heavy processing MUST use a localized `auditLimiter` (e.g. 3/min) AND strictly cap incoming `JSON.stringify(req.body).length` to prevent Serverless/Worker extortion.
- **Prompt Injection Firewall (APEX-SECURE):** Any system ingesting external text/repos MUST sanitize input for jailbreak patterns (`ignore previous`, etc.) BEFORE passing it to LLM evaluation logic.

### DB Security Rules

- **RLS ALWAYS ON:** Every new table MUST have `ENABLE ROW LEVEL SECURITY`.
- **Strict UUID Spoofing Prevention (APEX-SECURE):** Every RLS policy `FOR INSERT` MUST use `WITH CHECK ((SELECT auth.uid()) = user_id)`. Every policy `FOR DELETE` MUST use `USING ((SELECT auth.uid()) = user_id)`. 
- **No WITH CHECK (true):** Use `auth.role() = 'authenticated'` or `current_setting('role') = 'service_role'`.
- **SET search_path:** Every function MUST include `SET search_path = public`.
- **Extensions:** Install in `extensions` schema, never `public`.

## END-OF-MESSAGE DISCIPLINE (MANDATORY)

> **Every message that modifies code MUST end with:**
> 1. Build verification (`npx tsc -b && npx vite build` in egos-web)
> 2. `git add + commit` (conventional message)
> 3. `git push origin main`
> 4. `vercel inspect` or Vercel CLI to confirm deploy status = Ready
> 5. **Do NOT finalize message until deploy passes**

## ENV VARS

- **Graceful Degradation:** NEVER throw top-level errors for missing environment variables in shared utilities (like database clients). Use `console.warn` and provide fallback mock objects so builds (e.g., Vite/Next.js on Vercel) compile successfully without silent crashes.

```env
OPENROUTER_API_KEY=   # AI (Gemini via OpenRouter) â€” server-side only
GITHUB_TOKEN=         # GitHub API â€” server-side only
VITE_SUPABASE_URL=    # Supabase (client-safe)
VITE_SUPABASE_ANON_KEY= # Supabase anon (client-safe)
```


## ğŸ”„ Ambient Learned Rule (2026-02-20)
## SECURITY

- **Prompt Injection Firewall:** Any system ingesting external text/repos MUST sanitize input for jailbreak patterns (`ignore previous`, etc.) BEFORE passing it to LLM evaluation logic.