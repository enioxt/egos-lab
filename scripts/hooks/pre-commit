#!/bin/bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  pre-commit hook â€” Prevents secrets from being committed  â•‘
# â•‘  Install: cp scripts/hooks/pre-commit .git/hooks/         â•‘
# â•‘           chmod +x .git/hooks/pre-commit                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸ”’ Running security scan on staged files...${NC}"

# â”€â”€â”€ 1. Check for hardcoded secrets in staged files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Patterns that should NEVER appear in committed code
PATTERNS=(
  # Specific known patterns
  "sk-or-v1-"                              # OpenRouter API key
  "ghp_[A-Za-z0-9]{36}"                   # GitHub PAT (classic)
  "github_pat_"                             # GitHub PAT (fine-grained)
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"  # Supabase JWT prefix
  # Generic dangerous patterns
  "SUPABASE_DB_PASSWORD="                   # DB password assignment
  "password\s*=\s*['\"][^'\"]{8,}"          # Generic password assignment
  "BEGIN RSA PRIVATE KEY"                   # RSA keys
  "BEGIN OPENSSH PRIVATE KEY"               # SSH keys
)

FOUND_SECRETS=0

for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -lEn "$pattern" 2>/dev/null | grep -v "\.env\.example\|\.gitleaks\.toml\|pre-commit\|SECURITY\.md\|\.gitignore" || true)
  if [ -n "$MATCHES" ]; then
    echo -e "${RED}ğŸš¨ BLOCKED: Secret pattern found: ${pattern}${NC}"
    echo "$MATCHES"
    FOUND_SECRETS=1
  fi
done

# â”€â”€â”€ 2. Check if .env files are staged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ENV_FILES=$(echo "$STAGED_FILES" | grep -E '^\.env$|^\.env\.local|^\.env\.development|^\.env\.production|^\.env\.test' || true)
if [ -n "$ENV_FILES" ]; then
  echo -e "${RED}ğŸš¨ BLOCKED: .env file(s) staged for commit!${NC}"
  echo "$ENV_FILES"
  FOUND_SECRETS=1
fi

# â”€â”€â”€ 3. Use gitleaks if available â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if command -v gitleaks &> /dev/null; then
  echo -e "${GREEN}ğŸ“¡ Running gitleaks scan...${NC}"
  if ! gitleaks protect --staged --config .gitleaks.toml 2>/dev/null; then
    echo -e "${RED}ğŸš¨ BLOCKED: Gitleaks detected secrets!${NC}"
    FOUND_SECRETS=1
  fi
else
  echo -e "${YELLOW}âš ï¸  gitleaks not installed (recommended: brew install gitleaks)${NC}"
fi

# â”€â”€â”€ Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ $FOUND_SECRETS -ne 0 ]; then
  echo ""
  echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${RED}â•‘  COMMIT BLOCKED â€” Secrets detected in staged     â•‘${NC}"
  echo -e "${RED}â•‘  files. Remove credentials before committing.    â•‘${NC}"
  echo -e "${RED}â•‘                                                  â•‘${NC}"
  echo -e "${RED}â•‘  Use process.env.VAR_NAME instead of hardcoding. â•‘${NC}"
  echo -e "${RED}â•‘  To bypass (NOT recommended): git commit --no-verify${NC}"
  echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  exit 1
fi

echo -e "${GREEN}âœ… No secrets detected. Commit allowed.${NC}"
exit 0
